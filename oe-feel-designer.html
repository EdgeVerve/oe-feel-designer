<!--
Â©2015-2016 EdgeVerve Systems Limited (a fully owned Infosys subsidiary), Bangalore, India. All Rights Reserved.
-->
<link rel="import" href="all-imports.html">
<link rel="import" href="elements/oe-feel-editor.html">
<link rel="import" href="elements/oe-feel-footer.html">
<link rel="import" href="elements/oe-feel-component.html">
<dom-module id="oe-feel-designer">
    <template>
        <style>
             :host {
                position: relative;
                display: block;
                box-sizing: border-box;
                height: calc(100vh - 40px);
            }

            .component-container {
                height: 100%;
            }
        </style>
        <div class="component-container layout vertical">
            <div class="component-workspace layout horizontal flex">
                <oe-feel-editor decision-graph="[[_getCurrentGraph(_currentStackIndex)]]"></oe-feel-editor>
            </div>
        </div>
        <oe-feel-footer studio-footer hidden></oe-feel-footer>
    </template>
    <script>
        Polymer({
            is: "oe-feel-designer",
            properties: {
                
            },
            listeners: {
                'decision-graph-selected':'_graphSelected',
                'add-feel-component':'_handleAddNode',
                'delete-component':'_handleDeleteNode',
                'update-component-position':'_handlePositionUpdate',
                'undo-decision-graph':'_handleUndoGraph',
                'redo-decision-graph':'_handleRedoGraph',
                'update-connection':'_handleConnectionUpdate'
            },
            behaviors: [
            ],
            attached: function () {
                this.set('showActions', false);
            },
            _clearStack:function(){
                this.set('curGraphStack',[]);
                this.set('_currentStackIndex',-1);
            },
            _graphSelected: function (e) {
                var self = this;
                var graph = e.detail;
                this._clearStack();
                if(graph){
                    this._pushToStack(graph);
                }
            },
            _handleAddNode:function(e){
                var node = e.detail;
                var decisiongraph = this._getCurrentGraph(this._currentStackIndex);
                decisiongraph.graph.nodes.push(node);
                this._pushToStack(decisiongraph);
            },
            _handleDeleteNode:function(e){
                var nodeToDelete = e.detail;
                var decisiongraph = this._getCurrentGraph(this._currentStackIndex);
                var removeIndex = decisiongraph.graph.nodes.findIndex(function(node){
                    return node.id === nodeToDelete.id;
                });
                decisiongraph.graph.nodes.splice(removeIndex,1);
                decisiongraph.graph.connections = decisiongraph.graph.connections.filter(function(connection){
                    return (connection.from !== nodeToDelete.i && nodeToDelete.i !== connection.to);
                });
                this._pushToStack(decisiongraph);
            },
            _handlePositionUpdate:function(e){
                var detail = e.detail;
                var decisiongraph = this._getCurrentGraph(this._currentStackIndex);
                var updatedNode = decisiongraph.graph.nodes.find(function(node){
                    return node.i === detail.nodeIndex
                });
                updatedNode.x = detail.x;
                updatedNode.y = detail.y;
                this._pushToStack(decisiongraph);
            },
            _getCurrentGraph:function(index){
                if(index > -1){
                    var graph = JSON.parse(JSON.stringify(this.curGraphStack[index]));
                    return graph;
                }
            },
            _pushToStack:function(graph){
                this.curGraphStack.splice(this._currentStackIndex+1);
                this.push('curGraphStack',JSON.parse(JSON.stringify(graph)));
                this.set('_currentStackIndex',this._currentStackIndex+1);
                this._footerFire('stack-updated',{
                    curIndex:this._currentStackIndex,
                    stackLength:this.curGraphStack.length
                })
            },
            _footerFire: function (name, detail) {
                this.fire('oe-studio-footer-action', {
                    'event': name,
                    'payload': detail
                });
            },
            _handleUndoGraph:function(){
                if(this._currentStackIndex > 0){
                    this.set('_currentStackIndex',this._currentStackIndex-1);
                    this._footerFire('stack-updated',{
                        curIndex:this._currentStackIndex,
                        stackLength:this.curGraphStack.length
                    })
                }
            },
            _handleRedoGraph:function(){
                if(this._currentStackIndex < (this.curGraphStack.length-1)){
                    this.set('_currentStackIndex',this._currentStackIndex+1);
                    this._footerFire('stack-updated',{
                        curIndex:this._currentStackIndex,
                        stackLength:this.curGraphStack.length
                    })
                }
            },
            _handleConnectionUpdate:function(event){
                var newConnection = event.detail;
                var decisiongraph = this._getCurrentGraph(this._currentStackIndex);
                var prevIndex = decisiongraph.graph.connections.findIndex(function(conn){
                    return conn.from == newConnection.from && conn.to == newConnection.to;
                });
                if(prevIndex >= 0){
                    decisiongraph.graph.connections.splice(prevIndex,1,newConnection);
                }else{
                    decisiongraph.graph.connections.push(newConnection);
                }
                this._pushToStack(decisiongraph);
            }
        })
    </script>
</dom-module>